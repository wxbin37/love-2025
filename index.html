<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ æ˜Ÿç©ºä¸‹çš„å›å¿†å½•ï¼šå¿™ç¢Œå…ˆç”Ÿçš„è·¨å¹´ä¹‹ğŸ’Œï¸</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.8/jquery.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; }

        body {
            perspective: 1000px;
            transform-style: preserve-3d;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Microsoft YaHei', sans-serif;
            user-select: none;
        }

        /* Loading */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: #fff;
            transition: opacity 1s ease;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #ff69b4;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spinLoad 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spinLoad { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å¼€å§‹æŒ‰é’® */
        #start-btn {
            margin-top: 20px; padding: 10px 30px; background: transparent;
            border: 2px solid #ff69b4; color: #ff69b4; font-size: 18px;
            border-radius: 20px; cursor: pointer; transition: all 0.3s;
            animation: pulse 2s infinite;
        }
        #start-btn:hover { background: #ff69b4; color: white; box-shadow: 0 0 15px #ff69b4; }

        /* éŸ³ä¹å¡ç‰‡ */
        #music-player-card {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 10px; display: flex; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 260px;
            border: 1px solid rgba(255,255,255,0.5); font-family: "å¾®è½¯é›…é»‘", sans-serif;
        }
        .player-cover {
            width: 50px; height: 50px; border-radius: 50%; overflow: hidden;
            border: 2px solid #333; flex-shrink: 0; margin-right: 12px;
            animation: rotateMusic 5s linear infinite; animation-play-state: paused;
        }
        .player-cover img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { flex-grow: 1; overflow: hidden; }
        .song-title { font-size: 14px; color: #333; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .artist-name { font-size: 10px; color: #888; margin-bottom: 5px; }
        .progress-bar { width: 100%; height: 3px; background: #eee; border-radius: 2px; margin-bottom: 5px; }
        .progress-fill { width: 60%; height: 100%; background: #ff69b4; border-radius: 2px; }
        .player-controls { display: flex; justify-content: space-between; align-items: center; color: #ff69b4; font-size: 16px; padding-right: 5px; }
        .ctrl-btn { cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .ctrl-btn:hover { opacity: 1; transform: scale(1.1); }
        .play-btn { font-size: 18px; font-weight: bold; width: 20px; text-align: center; }
        @keyframes rotateMusic { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* èƒŒæ™¯è§†é¢‘ */
        #bg-video {
            position: fixed; top: 20%; left: 20%; width: 450px; height: auto;
            min-width: 0; max-height: 100vh; transform: translate(-50%, -50%) scale(1.3);
            object-fit: contain; z-index: 1; pointer-events: none;
            -webkit-mask-image: radial-gradient(ellipse at center, black 40%, transparent 80%);
            mask-image: radial-gradient(ellipse at center, black 40%, transparent 80%);
            mix-blend-mode: screen; opacity: 0; transition: opacity 1.5s ease;
        }
        @media (max-width: 768px) { #bg-video { width: 80%; left: 50%; top: 25%; opacity: 0.6; } }

        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

        /* 3Dç›¸å†Œ */
        #drag-container {
            position: relative; display: flex; margin: auto;
            transform-style: preserve-3d; transform: rotateX(-10deg);
            z-index: 10; left: 100px; transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #spin-container {
            position: relative; display: flex; width: 120px; height: 170px;
            transform-style: preserve-3d; animation: spinRevert 60s infinite linear;
        }
        #spin-container img {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            border-radius: 8px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
            -webkit-box-reflect: below 10px linear-gradient(transparent, transparent, rgba(0,0,0,0.3));
            cursor: pointer; transition: 0.3s;
        }
        #spin-container img:hover { box-shadow: 0 0 20px #ff99cc; transform: scale(1.1); }
        #spin-container p {
            position: absolute; top: 100%; left: 50%;
            transform: translate(-50%, -50%) rotateX(90deg);
            color: #fff; text-shadow: 0 0 10px #ff00de; font-size: 30px; white-space: nowrap;
        }
        #center-light {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            background: white; border-radius: 50%;
            transform: translate(-50%, -50%) rotateX(90deg);
            box-shadow: 0 0 50px 20px rgba(255, 0, 150, 0.5); opacity: 0.5; transition: all 1s ease;
        }
        #ground {
            width: 900px; height: 900px; position: absolute; top: 100%; left: 50%;
            transform: translate(-50%, -50%) rotateX(90deg);
            background: radial-gradient(center center, farthest-side, rgba(255, 0, 150, 0.15), transparent);
        }
        body.fountain-mode #drag-container { transform: translateY(350px) scale(0.5) rotateX(20deg) translateX(0px) !important; left: 0; opacity: 0.6; }
        body.fountain-mode #center-light { opacity: 1; box-shadow: 0 0 100px 50px rgba(255, 100, 200, 0.8), 0 0 200px 100px rgba(100, 200, 255, 0.4); }

        /* 3Dé­”æ–¹ */
        #cube-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; opacity: 0; transition: opacity 0.5s ease; perspective: 1000px;
        }
        #cube-overlay.active { pointer-events: auto; opacity: 1; }
        .box {
            width: 200px; height: 200px; position: relative; transform-style: preserve-3d;
            transform: rotateX(13deg); animation: move 5s linear infinite;
            scale: 0; transition: scale 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #cube-overlay.active .box { scale: 1; }
        .minbox { width: 100px; height: 100px; position: absolute; left: 50px; top: 50px; transform-style: preserve-3d; }
        .minbox li { width: 100px; height: 100px; position: absolute; left: 0; top: 0; list-style: none; }
        .minbox li:nth-child(1) { background: linear-gradient(45deg, #ff69b4, #ff1493); transform: translateZ(50px); }
        .minbox li:nth-child(2) { background: linear-gradient(45deg, #ff1493, #dc143c); transform: rotateX(180deg) translateZ(50px); }
        .minbox li:nth-child(3) { background: linear-gradient(45deg, #dc143c, #b22222); transform: rotateX(-90deg) translateZ(50px); }
        .minbox li:nth-child(4) { background: linear-gradient(45deg, #b22222, #8b0000); transform: rotateX(90deg) translateZ(50px); }
        .minbox li:nth-child(5) { background: linear-gradient(45deg, #8b0000, #ff69b4); transform: rotateY(-90deg) translateZ(50px); }
        .minbox li:nth-child(6) { background: linear-gradient(45deg, #ff69b4, #ff1493); transform: rotateY(90deg) translateZ(50px); }

        .maxbox { width: 200px; height: 200px; position: absolute; left: 0; top: 0; transform-style: preserve-3d; }
        .maxbox li {
            width: 200px; height: 200px; position: absolute; left: 0; top: 0; opacity: 0.9;
            transition: all 1s ease; list-style: none; border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px; box-shadow: 0 0 30px rgba(255, 105, 180, 0.4);
            background-size: cover; background-position: center; background-repeat: no-repeat;
            background-color: rgba(255,255,255,0.2);
        }
        .maxbox li:nth-child(1) { transform: translateZ(100px); }
        .maxbox li:nth-child(2) { transform: rotateX(180deg) translateZ(100px); }
        .maxbox li:nth-child(3) { transform: rotateX(-90deg) translateZ(100px); }
        .maxbox li:nth-child(4) { transform: rotateX(90deg) translateZ(100px); }
        .maxbox li:nth-child(5) { transform: rotateY(-90deg) translateZ(100px); }
        .maxbox li:nth-child(6) { transform: rotateY(90deg) translateZ(100px); }
        .box:hover .maxbox li:nth-child(1) { transform: translateZ(300px); }
        .box:hover .maxbox li:nth-child(2) { transform: rotateX(180deg) translateZ(300px); }
        .box:hover .maxbox li:nth-child(3) { transform: rotateX(-90deg) translateZ(300px); }
        .box:hover .maxbox li:nth-child(4) { transform: rotateX(90deg) translateZ(300px); }
        .box:hover .maxbox li:nth-child(5) { transform: rotateY(-90deg) translateZ(300px); }
        .box:hover .maxbox li:nth-child(6) { transform: rotateY(90deg) translateZ(300px); }
        .box:hover .minbox { transform: rotateX(45deg) rotateY(45deg); }
        .minbox li::before, .maxbox li::before {
            content: "â™¥"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); animation: pulse 2s ease-in-out infinite;
        }
        .minbox li::before { font-size: 3em; color: rgba(255,255,255,0.8); }
        .maxbox li::before { font-size: 5em; color: rgba(255,255,255,0.2); z-index: -1;}
        .cube-tip { position: absolute; bottom: -100px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 16px; letter-spacing: 2px; white-space: nowrap; text-shadow: 0 0 10px #ff00de; }

        /* ================= ç¤¼ç›’ç›¸å…³æ ·å¼ ================= */
        #gift-box {
            position: fixed; bottom: 50px; left: 50px; z-index: 999;
            width: 200px; height: auto; cursor: pointer; transition: all 0.5s ease;
            opacity: 0; pointer-events: none; transform: none !important; transform-style: flat !important;
        }
        #gift-box.visible { opacity: 1; pointer-events: auto; animation: floatFixed 3s ease-in-out infinite; }
        @keyframes floatFixed { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        .gift-img-container { width: 100%; height: 100%; position: relative; }
        #gift-img { width: 100%; height: 100%; object-fit: contain; transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #gift-box.opened #gift-img { content: url('gift2.png'); }

        /* ç¤¼ç‰©å¼¹çª— */
        #gift-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: all 0.8s ease;
        }
        #gift-popup.active { opacity: 1; pointer-events: auto; }

        /* çƒŸèŠ±ç”»å¸ƒ */
        #fireworks-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* ç©¿é€ï¼Œä¸å½±å“ç‚¹å‡» */
            z-index: 0; /* èƒŒæ™¯å±‚ */
        }

        /* å¼¹çª—å†…å®¹å®¹å™¨ï¼šå·¦å³å¸ƒå±€ */
        .gift-content {
            position: relative;
            width: 900px; /* å¢åŠ å®½åº¦ä»¥å®¹çº³ä¸¤æ  */
            max-width: 95vw;
            height: auto;
            max-height: 85vh;

            display: flex; /* Flexå¸ƒå±€ */
            flex-direction: row; /* æ°´å¹³æ’åˆ— */
            align-items: center;
            justify-content: center;
            gap: 20px;

            transform-style: preserve-3d;
            transform: scale(0.8) rotateY(20deg);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 2;
        }
        #gift-popup.active .gift-content { transform: scale(1) rotateY(0); }

        /* å·¦ä¾§æ–‡å­—åŒºåŸŸ */
        .gift-left-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 105, 180, 0.8);
            z-index: 20;
        }

        .cute-title {
            font-size: 32px;
            margin-bottom: 20px;
            color: #ff69b4;
            font-family: 'YouYuan', 'å¹¼åœ†', 'Comic Sans MS', 'Microsoft YaHei', sans-serif; /* å¯çˆ±å­—ä½“ */
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .cute-msg {
            font-size: 22px;
            line-height: 1.6;
            margin-bottom: 30px;
            font-weight: bold;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        /* é‚€çº¦æŒ‰é’® */
        .invite-btn {
            padding: 12px 35px;
            font-size: 20px;
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.6);
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Microsoft YaHei', sans-serif;
            animation: pulseBtn 2s infinite;
        }
        .invite-btn:hover {
            transform: scale(1.1) rotate(-3deg);
            box-shadow: 0 0 25px rgba(255, 105, 180, 1);
        }
        /* é‚€çº¦æˆåŠŸçŠ¶æ€ */
        .invite-btn.disabled {
            background: #ccc;
            background-image: none;
            color: #666;
            cursor: not-allowed;
            animation: none;
            box-shadow: none;
            transform: none;
        }

        @keyframes pulseBtn {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* å³ä¾§å›¾ç‰‡åŒºåŸŸ */
        .gift-right-img {
            flex: 1.2; /* å›¾ç‰‡åŒºåŸŸç¨å¾®å¤§ä¸€ç‚¹ */
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gift-image {
            width: 100%;
            height: auto;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 15px;
            border: 4px solid rgba(255, 45, 149, 0.8);
            box-shadow: 0 0 40px rgba(157, 0, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
        }

        /* ç§»åŠ¨ç«¯é€‚é…ï¼šæ”¹ä¸ºä¸Šä¸‹æ’åˆ— */
        @media (max-width: 768px) {
            .gift-content {
                flex-direction: column-reverse; /* å›¾ç‰‡åœ¨ä¸Šï¼Œæ–‡å­—åœ¨ä¸‹ï¼Œæˆ–è€… column è®©æ–‡å­—åœ¨ä¸Š */
                width: 90%;
            }
            .gift-left-text {
                padding: 10px;
            }
            .cute-title { font-size: 24px; }
            .cute-msg { font-size: 18px; }
            .gift-image { max-height: 40vh; }
        }

        .gift-close {
            position: absolute; top: -45px; right: 0; color: #fff; font-size: 28px; cursor: pointer;
            text-shadow: 0 0 15px #ff2d95; transition: all 0.3s;
            background: rgba(157, 0, 255, 0.3); width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid rgba(255, 45, 149, 0.8); box-shadow: 0 0 15px rgba(255, 45, 149, 0.7);
            z-index: 30;
        }
        .gift-close:hover { transform: scale(1.2); color: #ff2d95; background: rgba(157, 0, 255, 0.5); box-shadow: 0 0 25px rgba(255, 45, 149, 1); }
        .gift-popup-tip { position: absolute; bottom: -45px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 16px; text-shadow: 0 0 15px #ff2d95; font-weight: bold; }

        @keyframes move { 0% { transform: rotateX(13deg) rotateY(0deg); } 100% { transform: rotateX(13deg) rotateY(360deg); } }
        @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.2); } }
        @keyframes spin { from{transform: rotateY(0deg);} to{transform: rotateY(360deg);} }
        @keyframes spinRevert { from{transform: rotateY(360deg);} to{transform: rotateY(0deg);} }
    </style>
</head>
<body>

<div id="loading">
    <div class="loader"></div>
    <p>æ­£åœ¨æ”¶é›†å›å¿†...</p>
    <button id="start-btn" onclick="startExperience()" style="display:none;">âœ¨ å¼€å¯å›å¿† âœ¨</button>
</div>

<div id="music-player-card">
    <div class="player-cover">
        <img src="1.jpg" id="music-cover" alt="Cover">
    </div>
    <div class="player-info">
        <div class="song-title">è’²å…¬è‹±çš„çº¦å®š</div>
        <div class="artist-name">å‘¨æ°ä¼¦</div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <div class="player-controls">
            <span class="ctrl-btn">â®</span>
            <span class="ctrl-btn play-btn" onclick="toggleMusic()">||</span>
            <span class="ctrl-btn">â­</span>
            <span class="ctrl-btn volume">ğŸ”ˆ</span>
        </div>
    </div>
</div>

<audio id="bgmusic" src="M500004Yi5BD3ksoANä¼´å¥.wav" loop></audio>
<video id="bg-video" src="Main%20Comp.mp4" autoplay loop muted playsinline></video>
<canvas id="starfield"></canvas>

<div id="gift-box">
    <div class="gift-img-container">
        <img src="gift.png" alt="å…³é—­çš„ç¤¼ç›’" id="gift-img">
    </div>
</div>

<div id="gift-popup" onclick="closeGiftPopup(event)">
    <canvas id="fireworks-canvas"></canvas>

    <div class="gift-content">
        <div class="gift-close" onclick="closeGiftPopupForce(event)">âœ•</div>

        <div class="gift-left-text">
            <h2 class="cute-title">Dear è¯åŒ£å­å°å§</h2>
            <p class="cute-msg">
                ä»Šå¹´å¯ä»¥é™ªå¿™ç¢Œå…ˆç”Ÿ<br>
                ä¸€èµ·è·¨å¹´å˜›ï¼ï¼âœ¨
            </p>
            <button class="invite-btn" onclick="acceptInvitation(event)">
                åŒæ„ â¤ï¸
            </button>
        </div>

        <div class="gift-right-img">
            <img src="gift.jpg" alt="æƒŠå–œç¤¼ç‰©" class="gift-image" id="gift-image">
        </div>
    </div>

    <div class="gift-popup-tip">âœ¨ ç‚¹å‡»ç©ºç™½å¤„å…³é—­ âœ¨</div>
</div>

<div id="cube-overlay" onclick="closeView()">
    <div class="box">
        <ul class="minbox"><li></li><li></li><li></li><li></li><li></li><li></li></ul>
        <ol class="maxbox"><li></li><li></li><li></li><li></li><li></li><li></li></ol>
        <div class="cube-tip">âœ¨ ç‚¹å‡»ä»»æ„å¤„è¿”å› / é¼ æ ‡æ‚¬åœæŸ¥çœ‹ç»†èŠ‚ âœ¨</div>
    </div>
</div>

<div id="drag-container">
    <div id="spin-container">
        <div id="center-light"></div>
        <p>I â¤ï¸ You</p>
    </div>
    <div id="ground"></div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
    (function(){
        // âš ï¸ è¯·åŠ¡å¿…åœ¨è¿™é‡Œæ›¿æ¢ä½ çš„ EmailJS Public Key
        emailjs.init("WX1l_jaSGldk8Aads");
    })();
</script>

<script src="test.js"></script>

<script>
    // ===========================================
    // ä¿®å¤1ï¼šå®šä¹‰ test.js éœ€è¦çš„å…¨å±€å·¥å…· (é˜²æ­¢æŠ¥é”™)
    // ===========================================
    const fwCanvas = document.getElementById('fireworks-canvas');
    const fwCtx = fwCanvas.getContext('2d');

    // å…¨å±€å˜é‡ï¼šç”»å¸ƒå®½é«˜
    window.canvasWidth = window.innerWidth;
    window.canvasHeight = window.innerHeight;

    // å…¨å±€å·¥å…·ï¼šéšæœºæ•°
    window.getRandom = (min, max) => Math.random() * (max - min) + min;

    // å…¨å±€å·¥å…·ï¼šåˆ é™¤åˆ—è¡¨å…ƒç´ 
    window.deleteFromList = (list, target) => {
        const index = list.findIndex(item => item === target);
        if (index > -1) list.splice(index, 1);
    };

    // å…¨å±€å·¥å…·ï¼šç”»åœ†
    window.drawCircle = ({ opacity = 1, x, y, radius, color }) => {
        fwCtx.save();
        fwCtx.globalAlpha = opacity;
        fwCtx.beginPath();
        fwCtx.arc(x, y, radius, 0, Math.PI * 2);
        fwCtx.fillStyle = color;
        fwCtx.fill();
        fwCtx.restore();
    };

    // ===========================================
    // ã€æ ¸å¿ƒé»‘ç§‘æŠ€ã€‘: è¦†å†™çƒŸèŠ±çˆ†ç‚¸é€»è¾‘ï¼Œå˜æˆçˆ±å¿ƒå½¢çŠ¶ï¼
    // ===========================================
    if (typeof Explosive !== 'undefined') {
        Explosive.prototype.start = function (debrisNum, opt = {}) {
            const num = debrisNum || this.debrisNum;
            opt.x = opt.x || this.x;
            opt.y = opt.y || this.y;
            opt.secondBurst = false;

            // éšæœºçˆ±å¿ƒå¤§å° (1.5 ~ 4.0)
            const heartScale = getRandom(1.5, 4.0);

            // å¾ªç¯ç”Ÿæˆç²’å­
            for (let i = 0; i < num; i++) {
                const explosiveDebris = new ExplosiveDebris({
                    firework: this.firework,
                    color: this.color,
                    ...opt
                });

                // çˆ±å¿ƒæ•°å­¦å…¬å¼
                const angle = (Math.PI * 2 * i) / num;

                const vx = heartScale * (16 * Math.pow(Math.sin(angle), 3));
                const vy = heartScale * (13 * Math.cos(angle) - 5 * Math.cos(2 * angle) - 2 * Math.cos(3 * angle) - Math.cos(4 * angle));

                explosiveDebris.vx = vx * 0.08;
                explosiveDebris.vy = vy * 0.08;

                explosiveDebris.start();
                this.debrisList.push(explosiveDebris);
            }
            this.isFirstBurst = false;
        };
    }

    // ===========================================
    // ä¿®å¤2ï¼šçƒŸèŠ±æ§åˆ¶é€»è¾‘ (ä¾§è¾¹å‘å°„ + çˆ±å¿ƒå½¢çŠ¶)
    // ===========================================
    let fireworkList = [];
    let fwAnimationId = null;
    let fwTimer = null;

    // çª—å£å¤§å°è°ƒæ•´
    function resizeFwCanvas() {
        window.canvasWidth = window.innerWidth;
        window.canvasHeight = window.innerHeight;
        const ratio = Math.max(window.devicePixelRatio, 2);
        fwCanvas.width = window.canvasWidth * ratio;
        fwCanvas.height = window.canvasHeight * ratio;
        fwCanvas.style.width = window.canvasWidth + 'px';
        fwCanvas.style.height = window.canvasHeight + 'px';
        fwCtx.scale(ratio, ratio);
    }
    window.addEventListener('resize', resizeFwCanvas);

    // æ ¸å¿ƒç»˜å›¾å¾ªç¯
    function fwLoop() {
        fwCtx.save();
        // æ‹–å°¾æ•ˆæœ
        fwCtx.globalCompositeOperation = 'destination-out';
        fwCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        fwCtx.fillRect(0, 0, window.canvasWidth, window.canvasHeight);
        fwCtx.restore();

        fwCtx.save();
        // åæ ‡ç¿»è½¬ (ç¡®ä¿çƒŸèŠ±ä»ä¸‹å¾€ä¸Šé£)
        fwCtx.translate(0, window.canvasHeight);
        fwCtx.scale(1, -1);

        const list = [...fireworkList];
        list.forEach(firework => {
            firework.update();
            if (firework.isEnd()) {
                deleteFromList(fireworkList, firework);
            }
        });
        fwCtx.restore();

        fwAnimationId = requestAnimationFrame(fwLoop);
    }

    // å¼€å§‹æ”¾çƒŸèŠ±
    function startFireworks() {
        resizeFwCanvas();
        fireworkList = [];

        if (!fwAnimationId) fwLoop();

        if (!fwTimer) {
            fwTimer = setInterval(() => {
                if (typeof Firework !== 'undefined') {
                    const colors = ['#ff0043', '#14fc56', '#1e7fff', '#e60aff', '#ffbf36', '#ffffff'];
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];

                    // å·¦å³ä¾§å‘å°„ (30%)
                    const isLeft = Math.random() < 0.5;
                    let launchX;
                    if (isLeft) {
                        launchX = getRandom(window.canvasWidth * 0.05, window.canvasWidth * 0.30);
                    } else {
                        launchX = getRandom(window.canvasWidth * 0.70, window.canvasWidth * 0.95);
                    }

                    const firework = new Firework({
                        color: randomColor,
                        x: launchX,
                        y: window.canvasHeight
                    });

                    firework.launcher = new Launcher({
                        firework: firework,
                        color: randomColor,
                        x: launchX,
                        y: 0,
                        ty: window.canvasHeight * getRandom(0.6, 0.9)
                    });

                    firework.launch();
                    firework.launcher.x = launchX;
                    firework.launcher.ty = window.canvasHeight * getRandom(0.65, 0.9);

                    fireworkList.push(firework);
                }
            }, 800);
        }
    }

    function stopFireworks() {
        if (fwTimer) { clearInterval(fwTimer); fwTimer = null; }
        if (fwAnimationId) { cancelAnimationFrame(fwAnimationId); fwAnimationId = null; }
        fwCtx.clearRect(0, 0, window.canvasWidth, window.canvasHeight);
        fireworkList = [];
    }


    // ================= å…¶ä»–ä¸šåŠ¡é€»è¾‘ =================
    var radius = 240;
    var autoRotate = true;
    var rotateSpeed = -60;
    var imgWidth = 120;
    var imgHeight = 170;
    var maxCheckCount = 50;
    var fileExtension = '.jpg';
    var giftImageSrc = 'gift.jpg';
    var fallbackGiftImage = '1.jpg';
    var validImages = [];

    function detectImages() {
        let promises = [];
        for (let i = 1; i <= maxCheckCount; i++) {
            let p = new Promise((resolve) => {
                let img = new Image();
                let src = i + fileExtension;
                img.src = src;
                img.onload = function() { validImages.push({ src: src, index: i }); resolve(); };
                img.onerror = function() { resolve(); };
            });
            promises.push(p);
        }
        let giftPromise = new Promise((resolve) => {
            let giftImg = new Image();
            giftImg.src = giftImageSrc;
            giftImg.onload = function() { resolve(giftImageSrc); };
            giftImg.onerror = function() { resolve(fallbackGiftImage); };
        });

        Promise.all([...promises, giftPromise]).then((results) => {
            validImages.sort((a, b) => a.index - b.index);
            const finalGiftSrc = results[results.length - 1];
            document.getElementById('gift-image').src = finalGiftSrc;
            if (validImages.length === 0) {
                alert("æœªæ£€æµ‹åˆ°å›¾ç‰‡ï¼è¯·ç¡®ä¿æ–‡ä»¶å¤¹é‡Œæœ‰ 1.jpg, 2.jpg... æ ¼å¼çš„å›¾ç‰‡");
            } else {
                initScene(validImages);
            }
        });
    }

    function initScene(images) {
        const spinContainer = document.getElementById('spin-container');
        const pTag = spinContainer.querySelector('p');
        if(images.length > 0) document.getElementById('music-cover').src = images[0].src;
        images.forEach(imgData => {
            let img = document.createElement('img');
            img.src = imgData.src;
            img.onclick = function() { viewImage(this); };
            spinContainer.insertBefore(img, pTag);
        });
        init3DAlbum();
        setTimeout(() => {
            document.querySelector('.loader').style.display = 'none';
            document.querySelector('#loading p').style.display = 'none';
            document.getElementById('start-btn').style.display = 'block';
        }, 500);
    }

    function startExperience() {
        var loadingDiv = document.getElementById('loading');
        loadingDiv.style.opacity = 0;
        setTimeout(() => {
            loadingDiv.style.display = 'none';
            setTimeout(() => {
                document.getElementById('gift-box').classList.add('visible');
            }, 1500);
        }, 1000);
        document.getElementById('bg-video').style.opacity = 1;
        var music = document.getElementById("bgmusic");
        music.play().then(() => updateMusicState(true)).catch(e => console.log("éŸ³ä¹æ’­æ”¾å¤±è´¥", e));
        document.getElementById('bg-video').play().catch(e => console.log("è§†é¢‘æ’­æ”¾å¤±è´¥", e));
        document.getElementById('gift-box').addEventListener('click', openGiftBox);
    }

    function openGiftBox() {
        const giftPopup = document.getElementById('gift-popup');
        giftPopup.classList.remove('active');
        const giftBox = document.getElementById('gift-box');
        giftBox.classList.add('opened');
        try { const openSound = new Audio('open.mp3'); openSound.volume = 0.7; openSound.play().catch(e => {}); } catch (e) {}

        setTimeout(() => {
            giftPopup.classList.add('active');
            startFireworks();
        }, 300);
    }

    function closeGiftPopup(e) {
        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯ä¹Ÿå¯ä»¥å…³é—­ï¼Œä½†ä¸èƒ½ç‚¹å†…å®¹åŒºå…³é—­
        // ç¡®ä¿ç‚¹å‡»å†…å®¹åŒºä¸å…³é—­
        if (e.target.closest('.gift-content')) {
            return;
        }
        document.getElementById('gift-popup').classList.remove('active');
        stopFireworks();
    }

    function closeGiftPopupForce(e) {
        e.stopPropagation();
        document.getElementById('gift-popup').classList.remove('active');
        stopFireworks();
    }

    // ===========================================
    // é‚€çº¦é€»è¾‘ï¼šç‚¹å‡»åŒæ„åå‘é€é‚®ä»¶
    // ===========================================
    function acceptInvitation(e) {
        e.stopPropagation();
        const btn = e.target;

        // å¦‚æœå·²ç»ç‚¹è¿‡äº†ï¼Œå°±ä¸å†æ‰§è¡Œ
        if(btn.classList.contains('disabled')) return;

        // 1. æ”¹å˜æŒ‰é’®çŠ¶æ€
        btn.innerText = "é‚€çº¦æˆåŠŸ â¤ï¸";
        btn.classList.add('disabled');
        btn.disabled = true;

        // 2. è§¦å‘é‚®ä»¶å‘é€ (é€šçŸ¥ä½ å¥¹åŒæ„äº†)
        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å¡«å…¥ä½ è‡ªå·±çš„ Service ID å’Œ Template ID
        const serviceID = "service_hn7cjxf";
        const templateID = "template_j89kspc";

        const templateParams = {
            to_name: "å¿™ç¢Œå…ˆç”Ÿ", // ä½ çš„åå­—
            message: "è¯åŒ£å­å°å§ç‚¹å‡»äº†åŒæ„ï¼å¥¹æ„¿æ„é™ªä½ è·¨å¹´å•¦ï¼ğŸ‰"
        };

        emailjs.send(serviceID, templateID, templateParams)
            .then(() => {
                console.log("é‚®ä»¶å‘é€æˆåŠŸï¼");
                // å¯ä»¥åŠ ä¸ªå°å¼¹çª—æç¤º
                // alert("å·²é€šçŸ¥å¿™ç¢Œå…ˆç”Ÿï¼âœ¨");
            }, (err) => {
                console.log("å‘é€å¤±è´¥...", err);
            });
    }

    function toggleMusic() {
        var music = document.getElementById("bgmusic");
        if (music.paused) { music.play(); updateMusicState(true); } else { music.pause(); updateMusicState(false); }
    }

    function updateMusicState(isPlaying) {
        var cover = document.querySelector('.player-cover');
        var playBtn = document.querySelector('.play-btn');
        if (isPlaying) { cover.style.animationPlayState = 'running'; playBtn.innerHTML = '||'; } else { cover.style.animationPlayState = 'paused'; playBtn.innerHTML = 'â–¶'; }
    }

    window.onload = detectImages;

    var odrag = document.getElementById('drag-container');
    var ospin = document.getElementById('spin-container');
    var aImg, aEle;

    function init3DAlbum() {
        aImg = ospin.getElementsByTagName('img');
        aEle = [...aImg];
        var spacing = 20;
        var autoRadius = (aEle.length * (imgWidth + spacing)) / (2 * Math.PI);
        var finalRadius = Math.max(radius, autoRadius);
        ospin.style.width = imgWidth + "px";
        ospin.style.height = imgHeight + "px";
        var ground = document.getElementById('ground');
        ground.style.width = finalRadius * 3 + "px";
        ground.style.height = finalRadius * 3 + "px";
        for (var i = 0; i < aEle.length; i++) {
            var rotateY = i * (360 / aEle.length);
            aEle[i].style.transition = "transform 1s";
            aEle[i].style.transitionDelay = (aEle.length - i) / 4 + "s";
            aEle[i].style.transform = "rotateY(" + rotateY + "deg) translateZ(" + finalRadius + "px)";
        }
        startDragLogic();
    }

    function startDragLogic() {
        var sX, sY, nX, nY, desX = 0, desY = 0, tX = 0, tY = 10;
        if (autoRotate) {
            var animationName = (rotateSpeed > 0 ? 'spin' : 'spinRevert');
            ospin.style.animation = `${animationName} ${Math.abs(rotateSpeed)}s infinite linear`;
        }
        document.onpointerdown = function (e) {
            if(document.body.classList.contains('fountain-mode')) return;
            clearInterval(odrag.timer);
            e = e || window.event;
            var sX = e.clientX, sY = e.clientY;
            this.onpointermove = function (e) {
                e = e || window.event;
                var nX = e.clientX, nY = e.clientY;
                desX = nX - sX; desY = nY - sY;
                tX += desX * 0.1; tY += desY * 0.1;
                applyTransform(odrag, tX, tY);
                sX = nX; sY = nY;
            };
            this.onpointerup = function (e) {
                odrag.timer = setInterval(function () {
                    desX *= 0.95; desY *= 0.95; tX += desX * 0.1; tY += desY * 0.1;
                    applyTransform(odrag, tX, tY);
                    playSpin(false);
                    if (Math.abs(desX) < 0.5 && Math.abs(desY) < 0.5) { clearInterval(odrag.timer); playSpin(true); }
                }, 17);
                this.onpointermove = this.onpointerup = null;
            };
            return false;
        };
    }

    function applyTransform(obj, tX, tY) {
        if (tY > 180) tY = 180; if (tY < 0) tY = 0;
        obj.style.transform = "rotateX(" + (-tY) + "deg) rotateY(" + (tX) + "deg)";
    }
    function playSpin(yes) { ospin.style.animationPlayState = (yes ? 'running' : 'paused'); }

    // æ˜Ÿç©ºèƒŒæ™¯é€»è¾‘
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [], meteors = [];
    function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
    window.addEventListener('resize', resize); resize();
    class Star {
        constructor() { this.reset(); }
        reset() { this.x = Math.random() * width; this.y = Math.random() * height; this.z = Math.random() * width; this.size = Math.random() * 2; const colors = ['#FFFFFF','#FFC0CB','#87CEFA','#E6E6FA','#FFD700']; this.color = colors[Math.floor(Math.random() * colors.length)]; }
        update() { this.z -= 2; if (this.z <= 0) { this.reset(); this.z = width; } }
        draw() { const x = (this.x - width / 2) * (width / this.z) + width / 2; const y = (this.y - height / 2) * (width / this.z) + height / 2; const s = this.size * (width / this.z); ctx.beginPath(); ctx.fillStyle = this.color; ctx.arc(x, y, s, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 8; ctx.shadowColor = this.color; }
    }
    class Meteor {
        constructor() { this.reset(); }
        reset() { this.x = Math.random() * width + width; this.y = Math.random() * height * 0.5; this.len = Math.random() * 80 + 20; this.speed = Math.random() * 5 + 5; this.size = Math.random() * 1 + 0.5; this.opacity = 0; }
        update() { this.x -= this.speed; this.y += this.speed; if (this.x < width && this.x > width - 100) this.opacity += 0.05; else if (this.x < -100 || this.y > height) this.reset(); }
        draw() { ctx.save(); ctx.strokeStyle = `rgba(224, 255, 255, ${this.opacity})`; ctx.lineWidth = this.size; ctx.lineCap = 'round'; ctx.shadowBlur = 10; ctx.shadowColor = 'white'; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.len, this.y - this.len); ctx.stroke(); ctx.restore(); }
    }
    for (let i = 0; i < 800; i++) stars.push(new Star());
    for (let i = 0; i < 3; i++) meteors.push(new Meteor());
    function animate() {
        const gradient = ctx.createRadialGradient(width/2, height/2, 0, width/2, height/2, width);
        gradient.addColorStop(0, '#1a0b2e'); gradient.addColorStop(1, '#000000');
        ctx.fillStyle = gradient; ctx.fillRect(0, 0, width, height);
        stars.forEach(s => { s.update(); s.draw(); });
        meteors.forEach(m => { m.update(); m.draw(); });
        requestAnimationFrame(animate);
    }
    animate();

    function viewImage(imgObj) {
        var src = imgObj.src;
        var cubeFaces = document.querySelectorAll('.maxbox li');
        cubeFaces.forEach(function(li) { li.style.backgroundImage = 'url(' + src + ')'; });
        document.body.classList.add('fountain-mode');
        document.getElementById('cube-overlay').classList.add('active');
        event.stopPropagation();
    }
    function closeView() {
        document.body.classList.remove('fountain-mode');
        document.getElementById('cube-overlay').classList.remove('active');
    }
    document.addEventListener('gesturestart', function (e) { e.preventDefault(); });

    window.addEventListener('resize', function() {
        const giftBox = document.getElementById('gift-box');
        if (giftBox.classList.contains('visible')) {
            giftBox.style.zIndex = 999;
        }
    });
</script>
</body>
</html>